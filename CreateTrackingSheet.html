<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --primary-color: #1976d2;
      --hover-color: #1565c0;
      --text-color: #444;
      --light-bg: #f9f9f9;
      --border-color: #e0e0e0;
      --danger-color: #dc3545;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      font-size: 14px;
      color: var(--text-color);
      background-color: #fff;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--primary-color);
      font-size: 18px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary-color);
    }
    
    h4 {
      color: var(--primary-color);
      margin-bottom: 10px;
      border-bottom: 1px solid var(--primary-color);
      padding-bottom: 5px;
    }

    p {
      margin-bottom: 12px;
    }

    /* Tab Control Styles */
    .tab-container {
      margin-top: 20px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab-button {
      padding: 10px 20px;
      cursor: pointer;
      background: #f1f1f1;
      margin-right: 2px;
      border: 1px solid var(--border-color);
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      transition: all 0.2s ease;
    }
    
    .tab-button.active {
      background: white;
      font-weight: bold;
      color: var(--primary-color);
      border-bottom: 3px solid white;
      margin-bottom: -2px;
    }
    
    .tab-button:hover:not(.active) {
      background: #e5e5e5;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-top: none;
      background: white;
    }
    
    .tab-content.active {
      display: block;
    }

    /* Form controls */
    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 13px;
    }
    
    select, input, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 12px;
      font-size: 13px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }

    /* Job list textarea */
    #manualJobsList {
      height: 120px;
      font-family: monospace;
      resize: vertical;
    }

    /* Field Options styling to match Google Sheets */
    .field-section {
      margin-bottom: 30px;
    }

    .status-header, .type-header, .priority-header {
      color: var(--primary-color);
      font-size: 16px;
      font-weight: bold;
      border-bottom: 1px solid var(--primary-color);
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .field-description {
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .field-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      transition: transform 0.1s ease-in-out;
    }
    
    .field-item:hover {
      transform: translateY(-1px);
    }

    .text-input {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 10px;
    }

    .color-box {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 10px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .color-box:hover {
      transform: scale(1.1);
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .remove-btn {
      width: 32px;
      height: 32px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .remove-btn:hover {
      background: #5a6268;
    }

    .add-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    .add-btn:hover {
      background: #5a6268;
    }
    
    .add-btn:active {
      transform: translateY(1px);
    }

    /* Color Picker (Google Sheets Style) */
    #color-picker {
      display: none;
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 1000;
      width: 240px;
      border-radius: 4px;
    }

    .color-picker-title {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      margin: 4px 0 6px 0;
    }

    .color-grid {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .color-cell {
      width: 20px;
      height: 20px;
      margin: 2px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      transition: transform 0.15s ease;
    }
    
    .color-cell:hover {
      transform: scale(1.2);
      z-index: 1;
    }

    .color-cell.selected::after {
      content: "âœ“";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      text-shadow: 0 0 1px rgba(0,0,0,0.8);
    }

    /* Table Format Options */
    .format-options {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #eee;
      background-color: #f9f9f9;
      border-radius: 4px;
    }

    .format-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .format-checkbox {
      margin-right: 8px;
    }

    /* Action and notice areas */
    .action-area {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .notice {
      background-color: #fff3cd;
      color: #856404;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .create-default-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 13px;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    .create-default-btn:hover {
      background-color: var(--hover-color);
    }
    
    .create-default-btn:active {
      transform: translateY(1px);
    }

    /* Success/Error Dialogs */
    .dialog-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .dialog-box {
      width: 300px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 20px;
      text-align: center;
      animation: dialogFadeIn 0.3s ease forwards;
    }
    
    @keyframes dialogFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dialog-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .dialog-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .dialog-message {
      margin-bottom: 20px;
    }

    .dialog-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    .dialog-button:hover {
      background-color: var(--hover-color);
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.8);
      z-index: 2000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(25, 118, 210, 0.2);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-message {
      font-size: 16px;
      font-weight: bold;
      color: var(--primary-color);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Buttons */
    .buttons-container {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    button {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--hover-color);
    }
    
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    /* Helper text */
    .helper-text {
      font-size: 12px;
      color: #757575;
      margin-top: -8px;
      margin-bottom: 12px;
      font-style: italic;
    }
    
    /* Field selection checkboxes */
    .field-selections {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #e0e0e0;
    }

    .field-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .field-checkbox input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .field-checkbox input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .field-checkbox label {
      display: inline;
      margin: 0;
      font-weight: normal;
      font-size: 14px;
    }
    
    /* Info box in external links tab */
    .info-box {
      margin-top: 20px;
      padding: 12px 15px;
      background-color: #e8f4fd;
      border-left: 4px solid #1976d2;
      border-radius: 4px;
    }

    .info-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #1976d2;
    }

    .info-box ul {
      margin: 0;
      padding-left: 20px;
    }

    .info-box li {
      margin-bottom: 4px;
    }
    
    /* Custom fields section */
    .custom-fields-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #f0f7ff;
      border-radius: 5px;
      border: 1px solid #d0e2ff;
    }
    
    .custom-field-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    
    .custom-field-input {
      flex-grow: 1;
    }
    
    .custom-field-button {
      flex-shrink: 0;
      height: 37px;
      width: 37px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    /* Sample color block in descriptions */
    .color-sample {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 2px;
      border-radius: 2px;
      border: 1px solid #ccc;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h3>Create Tracking Sheet</h3>
  
  <div class="tab-container">
    <div class="tab-buttons">
      <div id="tab-btn-basics" class="tab-button active" onclick="showTab('basics')">Basics</div>
      <div id="tab-btn-external-links" class="tab-button" onclick="showTab('external-links')">External Links</div>
      <div id="tab-btn-fields" class="tab-button" onclick="showTab('fields')">Field Options</div>
    </div>
    
    <!-- Basics Tab -->
    <div id="tab-basics" class="tab-content active">
      <p>Set up basic information for your new tracking sheet.</p>
      
      <label for="jobSheetName">Sheet Name:</label>
      <input type="text" id="jobSheetName" value="Jobs" placeholder="Enter sheet name">
      <div class="helper-text">Default is "Jobs". Change this to create a new tracking sheet.</div>
      
      <label for="defaultJobsSource">Job Source:</label>
      <select id="defaultJobsSource" onchange="toggleJobSource()">
        <option value="empty">Empty sheet (headers only)</option>
        <option value="DefaultJobs">Use DefaultJobs sheet</option>
        <option value="manual">Enter jobs below</option>
      </select>
      
      <div id="defaultJobsInfo" style="display: none;" class="action-area">
        <div id="defaultJobsNotice" class="notice">
          Note: The DefaultJobs sheet will be used as a template. If it doesn't exist, you'll need to create it first.
        </div>
        <button id="createDefaultJobsBtn" class="create-default-btn" onclick="createDefaultJobsSheet()">
          Create DefaultJobs Sheet
        </button>
      </div>
      
      <div id="manualJobsInput" style="display: none;">
        <label for="manualJobsList">Enter job names (one per line):</label>
        <textarea id="manualJobsList" placeholder="Example:
Update database
Deploy application
Run tests
Review code changes"></textarea>
      </div>
      
      <div class="format-options">
        <div class="format-title">Table Formatting Options:</div>
        <div style="margin-bottom: 8px;">
          <input type="checkbox" id="formatAsTable" class="format-checkbox" checked>
          <label for="formatAsTable" style="display: inline; font-weight: normal;">Format as table (alternating row colors)</label>
        </div>
        <div>
          <input type="checkbox" id="freezeHeaders" class="format-checkbox" checked>
          <label for="freezeHeaders" style="display: inline; font-weight: normal;">Freeze header row</label>
        </div>
      </div>
    </div>
    
    <!-- External Links Tab -->
    <div id="tab-external-links" class="tab-content">
      <p>Configure external system URLs to enable hyperlinks in your tracking sheet.</p>
      
      <label for="jenkinsUrl">Jenkins URL:</label>
      <input type="text" id="jenkinsUrl" placeholder="https://jenkins.example.com">
      <div class="helper-text">
        Enter your Jenkins URL (e.g., https://jenkins.example.com). We'll automatically add "/job/" 
        if needed and handle all path formatting.
      </div>
      
      <label for="jiraUrl">Jira URL:</label>
      <input type="text" id="jiraUrl" placeholder="https://jira.example.com">
      <div class="helper-text">
        Enter your Jira URL (e.g., https://jira.example.com). We'll automatically add "/browse/" 
        if needed and handle all path formatting.
      </div>
      
      <div class="info-box">
        <div class="info-title">ðŸ“Œ URL Tips</div>
        <ul>
          <li>Both HTTP and HTTPS protocols are supported</li>
          <li>You can include or exclude trailing slashes - we'll handle it</li>
          <li>For Jenkins: if your URL already includes "/job", we'll detect it</li>
          <li>For Jira: if your URL already includes "/browse", we'll detect it</li>
          <li>Leaving URLs empty will use plain text (no hyperlinks)</li>
        </ul>
      </div>
    </div>
    
    <!-- Field Options Tab -->
    <div id="tab-fields" class="tab-content">
      <p>Customize the fields and dropdown options for your tracking sheet.</p>
      
      <!-- Field Selection Strategy Section -->
      <div class="field-section">
        <div class="status-header">Fields Setup Strategy</div>
        <div id="fields-strategy" class="field-selections">
          <div class="field-checkbox">
            <input type="radio" id="strategy-standard" name="fields-strategy" checked onchange="updateFieldStrategy('standard')">
            <label for="strategy-standard">Use standard fields + custom fields</label>
          </div>
          <div class="field-checkbox">
            <input type="radio" id="strategy-custom" name="fields-strategy" onchange="updateFieldStrategy('custom')">
            <label for="strategy-custom">Use fully customized fields</label>
          </div>
        </div>
      </div>
      
      <!-- Standard Fields Section -->
      <div class="field-section" id="standard-fields-section">
        <div class="status-header">Standard Fields</div>
        <div class="field-description">Select which standard fields to include in your tracking sheet.</div>
        <div id="field-selections" class="field-selections">
          <div class="field-checkbox">
            <input type="checkbox" id="field-jobname" checked disabled>
            <label for="field-jobname">Job Name (required)</label>
          </div>
          <div class="field-checkbox">
            <input type="checkbox" id="field-status" checked onchange="updateFieldVisibility()">
            <label for="field-status">Status</label>
          </div>
          <div class="field-checkbox">
            <input type="checkbox" id="field-type" checked onchange="updateFieldVisibility()">
            <label for="field-type">Type</label>
          </div>
          <div class="field-checkbox">
            <input type="checkbox" id="field-priority" checked onchange="updateFieldVisibility()">
            <label for="field-priority">Priority</label>
          </div>
          <div class="field-checkbox">
            <input type="checkbox" id="field-notes" checked>
            <label for="field-notes">Notes</label>
          </div>
          <div class="field-checkbox">
            <input type="checkbox" id="field-joblink" checked>
            <label for="field-joblink">Job Link</label>
          </div>
          <div class="field-checkbox">
            <input type="checkbox" id="field-jiraticket" checked>
            <label for="field-jiraticket">Jira Ticket</label>
          </div>
        </div>
      </div>
      
      <!-- Custom Fields Section -->
      <div class="field-section">
        <div class="status-header">Custom Fields</div>
        <div class="field-description" id="custom-fields-description">
          Add your own custom fields to the tracking sheet. These will be added in addition to the selected standard fields above.
        </div>
        <div id="custom-fields-container" class="custom-fields-section">
          <!-- Custom fields will be added here dynamically -->
          <div class="custom-field-row">
            <input type="text" class="custom-field-input" placeholder="Enter custom field name">
            <button type="button" class="custom-field-button btn-primary" onclick="addCustomFieldRow()">+</button>
          </div>
        </div>
      </div>
      
      <!-- Status Options -->
      <div class="field-section" id="status-section">
        <div class="status-header">Status Options</div>
        <div class="field-description">
          Define status options to track job progress. 
          Cells will be colored based on your selected colors
          (e.g., <span class="color-sample" style="background-color:#3d85c6"></span> Pending, 
          <span class="color-sample" style="background-color:#f1c232"></span> In-Progress,
          <span class="color-sample" style="background-color:#6aa84f"></span> Done).
        </div>
        <div id="status-items"></div>
        <button onclick="addFieldOption('status')" class="add-btn">+ Add Status</button>
      </div>
      
      <!-- Type Options -->
      <div class="field-section" id="type-section">
        <div class="type-header">Job Type Options</div>
        <div class="field-description">
          Define different types of jobs you want to track.
          Cells will be colored based on your selected colors
          (e.g., <span class="color-sample" style="background-color:#e69138"></span> Build,
          <span class="color-sample" style="background-color:#674ea7"></span> Test,
          <span class="color-sample" style="background-color:#3d85c6"></span> Deploy).
        </div>
        <div id="type-items"></div>
        <button onclick="addFieldOption('type')" class="add-btn">+ Add Type</button>
      </div>
      
      <!-- Priority Options -->
      <div class="field-section" id="priority-section">
        <div class="priority-header">Priority Options</div>
        <div class="field-description">
          Define priority levels for your jobs.
          Cells will be colored based on your selected colors
          (e.g., <span class="color-sample" style="background-color:#e06666"></span> High,
          <span class="color-sample" style="background-color:#f1c232"></span> Medium,
          <span class="color-sample" style="background-color:#6aa84f"></span> Low).
        </div>
        <div id="priority-items"></div>
        <button onclick="addFieldOption('priority')" class="add-btn">+ Add Priority</button>
      </div>
    </div>
  </div>

  <div class="buttons-container">
    <button id="cancelBtn" class="btn-secondary">Cancel</button>
    <button id="createBtn" class="btn-primary">Create Tracking Sheet</button>
  </div>
  
  <!-- Color Picker (Hidden) -->
  <div id="color-picker">
    <div class="color-picker-title">STANDARD</div>
    <div class="color-grid">
      <div class="color-cell" data-color="#000000" style="background-color: #000000"></div>
      <div class="color-cell" data-color="#434343" style="background-color: #434343"></div>
      <div class="color-cell" data-color="#666666" style="background-color: #666666"></div>
      <div class="color-cell" data-color="#999999" style="background-color: #999999"></div>
      <div class="color-cell" data-color="#b7b7b7" style="background-color: #b7b7b7"></div>
      <div class="color-cell" data-color="#cccccc" style="background-color: #cccccc"></div>
      <div class="color-cell" data-color="#d9d9d9" style="background-color: #d9d9d9"></div>
      <div class="color-cell" data-color="#efefef" style="background-color: #efefef"></div>
      <div class="color-cell" data-color="#f3f3f3" style="background-color: #f3f3f3"></div>
      <div class="color-cell" data-color="#ffffff" style="background-color: #ffffff"></div>
      
      <!-- Colors row 1 -->
      <div class="color-cell" data-color="#980000" style="background-color: #980000"></div>
      <div class="color-cell" data-color="#ff0000" style="background-color: #ff0000"></div>
      <div class="color-cell" data-color="#ff9900" style="background-color: #ff9900"></div>
      <div class="color-cell" data-color="#ffff00" style="background-color: #ffff00"></div>
      <div class="color-cell" data-color="#00ff00" style="background-color: #00ff00"></div>
      <div class="color-cell" data-color="#00ffff" style="background-color: #00ffff"></div>
      <div class="color-cell" data-color="#0000ff" style="background-color: #0000ff"></div>
      <div class="color-cell" data-color="#9900ff" style="background-color: #9900ff"></div>
      <div class="color-cell" data-color="#ff00ff" style="background-color: #ff00ff"></div>
      <div class="color-cell" data-color="#ff0099" style="background-color: #ff0099"></div>
      
      <!-- Lighter colors -->
      <div class="color-cell" data-color="#f4cccc" style="background-color: #f4cccc"></div>
      <div class="color-cell" data-color="#fce5cd" style="background-color: #fce5cd"></div>
      <div class="color-cell" data-color="#fff2cc" style="background-color: #fff2cc"></div>
      <div class="color-cell" data-color="#d9ead3" style="background-color: #d9ead3"></div>
      <div class="color-cell" data-color="#d0e0e3" style="background-color: #d0e0e3"></div>
      <div class="color-cell" data-color="#cfe2f3" style="background-color: #cfe2f3"></div>
      <div class="color-cell" data-color="#d9d2e9" style="background-color: #d9d2e9"></div>
      <div class="color-cell" data-color="#ead1dc" style="background-color: #ead1dc"></div>
    </div>
    
    <div class="color-picker-title">COMMON</div>
    <div class="color-grid">
      <div class="color-cell" data-color="#000000" style="background-color: #000000"></div>
      <div class="color-cell" data-color="#ffffff" style="background-color: #ffffff"></div>
      <div class="color-cell" data-color="#3d85c6" style="background-color: #3d85c6"></div>
      <div class="color-cell" data-color="#e06666" style="background-color: #e06666"></div>
      <div class="color-cell" data-color="#f1c232" style="background-color: #f1c232"></div>
      <div class="color-cell" data-color="#6aa84f" style="background-color: #6aa84f"></div>
      <div class="color-cell" data-color="#e69138" style="background-color: #e69138"></div>
      <div class="color-cell" data-color="#45818e" style="background-color: #45818e"></div>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-message">Creating tracking sheet...</div>
  </div>
  
  <!-- Success Dialog -->
  <div id="success-dialog" class="dialog-overlay">
    <div class="dialog-box">
      <div class="dialog-icon" style="color: var(--success-color);">âœ“</div>
      <div class="dialog-title">Success!</div>
      <div id="success-message" class="dialog-message">Operation completed successfully.</div>
      <button class="dialog-button" onclick="closeDialog('success-dialog')">OK</button>
    </div>
  </div>
  
  <!-- Error Dialog -->
  <div id="error-dialog" class="dialog-overlay">
    <div class="dialog-box">
      <div class="dialog-icon" style="color: var(--danger-color);">âœ—</div>
      <div class="dialog-title">Error</div>
      <div id="error-message" class="dialog-message">An error occurred.</div>
      <button class="dialog-button" onclick="closeDialog('error-dialog')">OK</button>
    </div>
  </div>

  <script>
    // Default field values
    const defaultValues = {
      status: [
        { name: "Pending", color: "#3d85c6" },
        { name: "In-Progress", color: "#f1c232" },
        { name: "Done", color: "#6aa84f" }
      ],
      type: [
        { name: "Build", color: "#e69138" },
        { name: "Test", color: "#674ea7" },
        { name: "Deploy", color: "#3d85c6" }
      ],
      priority: [
        { name: "High", color: "#e06666" },
        { name: "Medium", color: "#f1c232" },
        { name: "Low", color: "#6aa84f" }
      ]
    };
    
    // Track current active color button
    let activeColorButton = null;
    let defaultJobsSheetExists = false;
    
    // Track the color picker position and scroll
    let previousScrollY = 0;
    
    document.addEventListener("DOMContentLoaded", function() {
      // Show the default tab
      showTab('basics');
      
      // Initialize field options
      setupFieldOptions();
      
      // Toggle job source initially
      toggleJobSource();
      
      // Check if DefaultJobs sheet exists
      checkDefaultJobsSheet();
      
      // Load integration settings
      loadSettings();
      
      // Set up event listeners
      document.getElementById("defaultJobsSource").addEventListener("change", toggleJobSource);
      document.getElementById("createBtn").addEventListener("click", createTrackingSheet);
      document.getElementById("cancelBtn").addEventListener("click", () => {
        google.script.host.close();
      });
      
      // Update field sections visibility
      updateFieldVisibility();
      
      // Set up color cell click handlers
      document.querySelectorAll('.color-cell').forEach(cell => {
        cell.addEventListener('click', function(e) {
          e.stopPropagation();
          if (activeColorButton) {
            // Update active button color
            activeColorButton.style.backgroundColor = this.dataset.color;
            activeColorButton.dataset.color = this.dataset.color;
            
            // Hide color picker
            document.getElementById('color-picker').style.display = 'none';
            activeColorButton = null;
          }
        });
      });
      
      // Close color picker when clicking outside
      document.addEventListener('click', function(e) {
        const colorPicker = document.getElementById('color-picker');
        if (colorPicker.style.display === 'block' && 
            !colorPicker.contains(e.target) && 
            !e.target.classList.contains('color-box')) {
          colorPicker.style.display = 'none';
          activeColorButton = null;
        }
      });
      
      // Handle scroll events for color picker repositioning
      window.addEventListener('scroll', function() {
        const colorPicker = document.getElementById('color-picker');
        if (colorPicker.style.display === 'block' && activeColorButton) {
          // Adjust color picker position when scrolling
          const scrollDiff = window.scrollY - previousScrollY;
          const currentTop = parseInt(colorPicker.style.top) || 0;
          colorPicker.style.top = (currentTop - scrollDiff) + 'px';
          previousScrollY = window.scrollY;
        }
      }, true);
    });
    
    function setupFieldOptions() {
      // Setup each field type
      createFieldItems('status');
      createFieldItems('type');
      createFieldItems('priority');
    }
    
    // Controls visibility of field option sections based on checkboxes
    function updateFieldVisibility() {
      const statusEnabled = document.getElementById('field-status').checked;
      const typeEnabled = document.getElementById('field-type').checked;
      const priorityEnabled = document.getElementById('field-priority').checked;
      
      // Show/hide field sections based on checkbox state
      document.getElementById('status-section').style.display = statusEnabled ? 'block' : 'none';
      document.getElementById('type-section').style.display = typeEnabled ? 'block' : 'none';
      document.getElementById('priority-section').style.display = priorityEnabled ? 'block' : 'none';
    }
    
    // Controls the field strategy (standard vs custom)
    function updateFieldStrategy(strategy) {
      if (strategy === 'standard') {
        // Standard mode: Show standard fields section
        document.getElementById('standard-fields-section').style.display = 'block';
        document.getElementById('custom-fields-description').textContent = 
          'Add your own custom fields to the tracking sheet. These will be added in addition to the selected standard fields above.';
      } else if (strategy === 'custom') {
        // Custom mode: Hide standard fields section
        document.getElementById('standard-fields-section').style.display = 'none';
        document.getElementById('custom-fields-description').textContent = 
          'Define all fields for your tracking sheet. "Job Name" will automatically be included as the first field.';
        
        // Ensure there are enough rows to define fields
        ensureCustomFieldRows(3); // Ensure at least 3 rows for custom fields
      }
    }
    
    function ensureCustomFieldRows(minCount) {
      const container = document.getElementById('custom-fields-container');
      const currentRows = container.querySelectorAll('.custom-field-row').length;
      
      // Add rows if needed
      for (let i = currentRows; i < minCount; i++) {
        addCustomFieldRow();
      }
    }
    
    // Add a new custom field input row
    function addCustomFieldRow() {
      const container = document.getElementById('custom-fields-container');
      const allRows = container.querySelectorAll('.custom-field-row');
      
      // Get the last row and check if it has content
      const lastRow = allRows[allRows.length - 1];
      const lastInput = lastRow.querySelector('input');
      
      if (lastInput && !lastInput.value.trim()) {
        // If last row is empty, just focus it instead of adding a new one
        lastInput.focus();
        return;
      }
      
      // Create a new row
      const newRow = document.createElement('div');
      newRow.className = 'custom-field-row';
      
      // Create input
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'custom-field-input';
      input.placeholder = 'Enter custom field name';
      
      // Create remove button
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'custom-field-button btn-danger';
      button.innerHTML = 'âˆ’';
      button.onclick = function() {
        container.removeChild(newRow);
      };
      
      // Add elements to row
      newRow.appendChild(input);
      newRow.appendChild(button);
      
      // Add row before the add row
      container.appendChild(newRow);
      
      // Focus the new input
      input.focus();
    }
    
    // Get all custom fields
    function getCustomFields() {
      const container = document.getElementById('custom-fields-container');
      const inputs = container.querySelectorAll('input');
      const customFields = [];
      
      inputs.forEach(input => {
        const fieldName = input.value.trim();
        if (fieldName) {
          customFields.push(fieldName);
        }
      });
      
      return customFields;
    }
    
    function createFieldItems(type) {
      const container = document.getElementById(`${type}-items`);
      container.innerHTML = ''; // Clear container
      
      // Add default values
      defaultValues[type].forEach((value, index) => {
        addFieldItem(type, value.name, value.color, index === 0);
      });
    }
    
    function addFieldItem(type, name, color, isRequired = false) {
      const container = document.getElementById(`${type}-items`);
      
      // Create field item
      const item = document.createElement('div');
      item.className = 'field-item';
      
      // Create text input
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'text-input';
      input.value = name;
      input.readOnly = isRequired;
      
      // Create color box
      const colorBox = document.createElement('div');
      colorBox.className = 'color-box';
      colorBox.style.backgroundColor = color;
      colorBox.dataset.color = color;
      colorBox.addEventListener('click', function(e) {
        showColorPicker(e, this);
      });
      
      // Create remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.innerHTML = 'âˆ’';
      removeBtn.style.display = isRequired ? 'none' : 'block';
      
      // Fix: Ensure the remove button works properly
      removeBtn.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent form submission
        e.stopPropagation(); // Prevent event bubbling
        if (container && item) {
          container.removeChild(item);
        }
      });
      
      // Add elements to item
      item.appendChild(input);
      item.appendChild(colorBox);
      item.appendChild(removeBtn);
      
      // Add item to container
      container.appendChild(item);
    }
    
    function addFieldOption(type) {
      let defaultColor;
      let defaultName;
      
      // Set default values based on type
      if (type === 'status') {
        defaultColor = '#3d85c6';
        defaultName = 'New Status';
      } else if (type === 'type') {
        defaultColor = '#e69138';
        defaultName = 'New Type';
      } else if (type === 'priority') {
        defaultColor = '#e06666';
        defaultName = 'New Priority';
      }
      
      addFieldItem(type, defaultName, defaultColor, false);
    }
    
    function showColorPicker(event, colorBox) {
      event.stopPropagation();
      
      // Store current scroll position
      previousScrollY = window.scrollY;
      
      // Set active color box
      activeColorButton = colorBox;
      
      // Get color picker
      const colorPicker = document.getElementById('color-picker');
      
      // Position color picker - Improved positioning logic
      const rect = colorBox.getBoundingClientRect();
      const pickerHeight = 320; // Approximate picker height
      const pickerWidth = 240; // Approximate picker width
      
      // Get viewport dimensions
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      
      // Calculate the best position for the picker
      let topPosition, leftPosition;
      
      // Vertical position - try to keep it visible
      if (rect.bottom + pickerHeight > viewportHeight && rect.top > pickerHeight/2) {
        // Place above if there's more space above
        topPosition = window.scrollY + rect.top - pickerHeight - 5;
      } else {
        // Otherwise place below
        topPosition = window.scrollY + rect.bottom + 5;
      }
      
      // Horizontal position - center on the color box by default
      leftPosition = rect.left + rect.width/2 - pickerWidth/2;
      
      // Adjust horizontal position to keep within viewport
      if (leftPosition < 5) {
        leftPosition = 5;
      } else if (leftPosition + pickerWidth > viewportWidth - 5) {
        leftPosition = viewportWidth - pickerWidth - 5;
      }
      
      // Apply positions - use fixed positioning for better scrolling behavior
      colorPicker.style.position = 'absolute';
      colorPicker.style.top = `${topPosition}px`;
      colorPicker.style.left = `${leftPosition}px`;
      
      // Update selected color
      const selectedColor = colorBox.dataset.color;
      document.querySelectorAll('.color-cell').forEach(cell => {
        cell.classList.remove('selected');
        if (cell.dataset.color === selectedColor) {
          cell.classList.add('selected');
        }
      });
      
      // Show color picker
      colorPicker.style.display = 'block';
      
      // Check if the picker is visible in the viewport
      const pickerRect = colorPicker.getBoundingClientRect();
      if (pickerRect.top < 0 || pickerRect.bottom > viewportHeight) {
        // If not visible, scroll to make it visible
        colorPicker.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
    
    function checkDefaultJobsSheet() {
      google.script.run
        .withSuccessHandler(function(exists) {
          defaultJobsSheetExists = exists;
          updateDefaultJobsNotice();
        })
        .withFailureHandler(function(error) {
          console.error("Failed to check DefaultJobs sheet:", error);
          defaultJobsSheetExists = false;
          updateDefaultJobsNotice();
        })
        .checkDefaultJobsSheetExists();
    }
    
    function createDefaultJobsSheet() {
      showLoading(true);
      
      // Add timeout protection to prevent UI from getting stuck
      const timeoutId = setTimeout(function() {
        showLoading(false);
        showErrorDialog('Operation timed out. The server took too long to respond. Please try again.');
      }, 15000); // 15-second timeout
      
      google.script.run
        .withSuccessHandler(function(result) {
          clearTimeout(timeoutId); // Clear the timeout
          showLoading(false);
          
          if (result && result.status === 'success') {
            showSuccessDialog('DefaultJobs sheet created successfully!');
            defaultJobsSheetExists = true;
            updateDefaultJobsNotice();
          } else {
            const errorMsg = (result && result.message) ? result.message : 'Failed to create DefaultJobs sheet with unknown error.';
            showErrorDialog(errorMsg);
            console.error('Error creating DefaultJobs sheet:', result);
          }
        })
        .withFailureHandler(function(error) {
          clearTimeout(timeoutId); // Clear the timeout
          showLoading(false);
          showErrorDialog('Failed to create DefaultJobs sheet: ' + error);
          console.error('Error creating DefaultJobs sheet:', error);
        })
        .createDefaultJobsTemplate();
    }
    
    function updateDefaultJobsNotice() {
      const notice = document.getElementById('defaultJobsNotice');
      const createBtn = document.getElementById('createDefaultJobsBtn');
      
      if (defaultJobsSheetExists) {
        notice.innerHTML = 'The DefaultJobs sheet exists and will be used as a template.';
        notice.style.backgroundColor = '#d4edda';
        notice.style.color = '#155724';
        createBtn.style.display = 'none';
      } else {
        notice.innerHTML = 'The DefaultJobs sheet does not exist. Click the button below to create it.';
        notice.style.backgroundColor = '#fff3cd';
        notice.style.color = '#856404';
        createBtn.style.display = 'block';
      }
    }
    
    function toggleJobSource() {
      const source = document.getElementById("defaultJobsSource").value;
      
      // Hide all divs first
      document.getElementById("defaultJobsInfo").style.display = "none";
      document.getElementById("manualJobsInput").style.display = "none";
      
      // Show the appropriate div based on selection
      if (source === "DefaultJobs") {
        document.getElementById("defaultJobsInfo").style.display = "block";
      } else if (source === "manual") {
        document.getElementById("manualJobsInput").style.display = "block";
      }
    }
    
    function loadSettings() {
      // Load integration settings if available
      google.script.run
          .withSuccessHandler(loadIntegrationSettings)
          .withFailureHandler(error => console.error("Integration settings error:", error))
          .getIntegrationSettings();
    }
    
    function loadIntegrationSettings(settings) {
      if (settings) {
        // Remove any trailing slashes
        let jenkinsUrl = settings.jenkinsUrl || "";
        let jiraUrl = settings.jiraUrl || "";
        
        document.getElementById("jenkinsUrl").value = jenkinsUrl;
        document.getElementById("jiraUrl").value = jiraUrl;
      }
    }
    
    function showTab(tabName) {
      // Hide all tabs
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      
      // Deactivate all tab buttons
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      // Show selected tab
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.getElementById(`tab-btn-${tabName}`).classList.add('active');
    }
    
    function createTrackingSheet() {
      const sheetName = document.getElementById("jobSheetName").value.trim();
      if (!sheetName) {
        showErrorDialog('Please enter a sheet name');
        return;
      }
      
      const source = document.getElementById("defaultJobsSource").value;
      
      // Get manual job list if needed
      let manualJobs = [];
      if (source === "manual") {
        const jobsList = document.getElementById("manualJobsList").value;
        if (jobsList.trim()) {
          manualJobs = jobsList.trim().split('\n').map(job => job.trim()).filter(job => job);
        }
      }
      
      // Table formatting options
      const formatAsTable = document.getElementById("formatAsTable").checked;
      const freezeHeaders = document.getElementById("freezeHeaders").checked;
      
      // Determine field strategy
      const useCustomFieldsOnly = document.getElementById("strategy-custom").checked;
      
      // Collect selected fields
      let selectedFields = ['Job Name']; // Job Name is always required
      
      if (!useCustomFieldsOnly) {
        // Add standard fields if they're selected
        if (document.getElementById('field-status').checked) selectedFields.push('Status');
        if (document.getElementById('field-type').checked) selectedFields.push('Type');
        if (document.getElementById('field-priority').checked) selectedFields.push('Priority');
        if (document.getElementById('field-notes').checked) selectedFields.push('Notes');
        if (document.getElementById('field-joblink').checked) selectedFields.push('Job Link');
        if (document.getElementById('field-jiraticket').checked) selectedFields.push('Jira Ticket');
      }
      
      // Add custom fields
      const customFields = getCustomFields();
      if (customFields.length > 0) {
        selectedFields.push(...customFields);
      }
      
      // Collect field options
      const fieldOptions = {
        statuses: getFieldValues('status'),
        types: getFieldValues('type'),
        priorities: getFieldValues('priority'),
        statusColors: getFieldColors('status'),
        typeColors: getFieldColors('type'),
        priorityColors: getFieldColors('priority'),
        selectedFields: selectedFields
      };
      
      // Validate required field options
      if (document.getElementById('field-status').checked && fieldOptions.statuses.length === 0) {
        showErrorDialog('You must have at least one Status option');
        showTab('fields');
        return;
      }
      
      if (document.getElementById('field-type').checked && fieldOptions.types.length === 0) {
        showErrorDialog('You must have at least one Job Type option');
        showTab('fields');
        return;
      }
      
      if (document.getElementById('field-priority').checked && fieldOptions.priorities.length === 0) {
        showErrorDialog('You must have at least one Priority option');
        showTab('fields');
        return;
      }
      
      // Collect integration settings
      let jenkinsUrl = document.getElementById("jenkinsUrl").value.trim();
      let jiraUrl = document.getElementById("jiraUrl").value.trim();
      
      // Remove trailing slashes
      if (jenkinsUrl.endsWith('/')) {
        jenkinsUrl = jenkinsUrl.slice(0, -1);
      }
      
      if (jiraUrl.endsWith('/')) {
        jiraUrl = jiraUrl.slice(0, -1);
      }
      
      const integrationSettings = {
        jenkinsUrl: jenkinsUrl,
        jiraUrl: jiraUrl
      };
      
      // Show loading overlay
      showLoading(true);
      
      // Add timeout protection
      const timeoutId = setTimeout(function() {
        showLoading(false);
        showErrorDialog('Operation timed out. The server took too long to respond. Please try again.');
      }, 30000); // 30-second timeout
      
      // First check if DefaultJobs sheet exists if that's the selected source
      if (source === 'DefaultJobs') {
        // Verify DefaultJobs sheet exists first
        google.script.run
          .withSuccessHandler(function(exists) {
            if (!exists) {
              clearTimeout(timeoutId);
              showLoading(false);
              showErrorDialog('DefaultJobs sheet does not exist. Please create it first.');
              return;
            }
            
            // Continue with normal flow if sheet exists
            saveSettingsAndCreate();
          })
          .withFailureHandler(function(error) {
            clearTimeout(timeoutId);
            showLoading(false);
            showErrorDialog('Error checking DefaultJobs sheet: ' + error);
          })
          .checkDefaultJobsSheetExists();
      } else {
        // For other sources, proceed directly
        saveSettingsAndCreate();
      }
      
      // Helper function to continue the flow
      function saveSettingsAndCreate() {
        // Save integration settings first
        google.script.run
          .withSuccessHandler(() => {
            // Then create the tracking sheet with field options
            google.script.run
              .withSuccessHandler(function(result) {
                clearTimeout(timeoutId); // Clear the timeout
                showLoading(false);
                
                if (result && result.status === 'success') {
                  showSuccessDialog(result.message || 'Tracking sheet created successfully!', function() {
                    google.script.host.close();
                  });
                } else {
                  const errorMsg = (result && result.message) ? result.message : 'Failed to create tracking sheet with unknown error.';
                  showErrorDialog(errorMsg);
                  console.error('Error creating tracking sheet:', result);
                }
              })
              .withFailureHandler(function(error) {
                clearTimeout(timeoutId); // Clear the timeout
                showLoading(false);
                showErrorDialog('Failed to create tracking sheet: ' + error);
                console.error('Error creating tracking sheet:', error);
              })
              .createTrackingSheetWithOptions(sheetName, source, fieldOptions, manualJobs, {
                formatAsTable: formatAsTable,
                freezeHeaders: freezeHeaders
              });
          })
          .withFailureHandler(function(error) {
            clearTimeout(timeoutId); // Clear the timeout
            showLoading(false);
            showErrorDialog('Failed to save external link settings: ' + error);
            console.error('Error saving integration settings:', error);
          })
          .saveIntegrationSettings(integrationSettings);
      }
    }
    
    function getFieldValues(type) {
      const container = document.getElementById(`${type}-items`);
      const items = container.querySelectorAll('.field-item');
      const values = [];
      
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const textInput = item.querySelector('.text-input');
        
        if (textInput.value.trim()) {
          values.push(textInput.value.trim());
        }
      }
      
      return values;
    }
    
    function getFieldColors(type) {
      const container = document.getElementById(`${type}-items`);
      const items = container.querySelectorAll('.field-item');
      const colors = [];
      
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const textInput = item.querySelector('.text-input');
        const colorBox = item.querySelector('.color-box');
        
        if (textInput.value.trim()) {
          colors.push(colorBox.dataset.color);
        }
      }
      
      return colors;
    }
    
    function showLoading(show) {
      document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }
    
    function showSuccessDialog(message, callback) {
      document.getElementById('success-message').textContent = message;
      document.getElementById('success-dialog').style.display = 'flex';
      
      // Store callback if provided
      if (callback) {
        document.getElementById('success-dialog').dataset.callback = 'true';
      } else {
        delete document.getElementById('success-dialog').dataset.callback;
      }
      
      // Store callback function
      document.getElementById('success-dialog')._callback = callback;
    }
    
    function showErrorDialog(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-dialog').style.display = 'flex';
    }
    
    function closeDialog(dialogId) {
      const dialog = document.getElementById(dialogId);
      dialog.style.display = 'none';
      
      // Execute callback if exists
      if (dialog.dataset.callback && typeof dialog._callback === 'function') {
        dialog._callback();
      }
    }
  </script>
</body>
</html>