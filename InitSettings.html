<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --primary-color: #1976d2;
      --hover-color: #1565c0;
      --text-color: #444;
      --light-bg: #f9f9f9;
      --border-color: #e0e0e0;
      --danger-color: #dc3545;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --header-color: #37474f;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 16px;
      font-size: 14px;
      color: var(--text-color);
      background-color: #fff;
      line-height: 1.5;
    }

    h3, h4 {
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--header-color);
      font-size: 18px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h3 .icon {
      font-size: 22px;
    }
    
    h4 {
      margin-top: 24px;
      font-size: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    h4 .icon {
      font-size: 18px;
    }

    /* Tab Control Styles */
    .tab-container {
      margin-top: 20px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: -1px;
    }
    
    .tab-button {
      padding: 12px 20px;
      cursor: pointer;
      background: #f1f1f1;
      border: 1px solid var(--border-color);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-button .icon {
      font-size: 16px;
    }
    
    .tab-button.active {
      background: white;
      color: var(--primary-color);
      border-bottom: 2px solid white;
      margin-bottom: -2px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    
    .tab-button:hover:not(.active) {
      background: #e5e5e5;
      transform: translateY(-1px);
    }
    
    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-top: none;
      background: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Property item styling */
    .property-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--light-bg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .property-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    .property-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .value-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .value-box {
      display: flex;
      align-items: center;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .value-box:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    .color-picker {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid #ccc;
      transition: transform 0.2s;
      margin-left: 8px;
    }
    
    .color-picker:hover {
      transform: scale(1.1);
    }

    .remove-btn, .remove-value-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 8px;
      transition: all 0.2s;
      font-weight: 500;
    }

    .remove-btn:hover, .remove-value-btn:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .remove-btn:active, .remove-value-btn:active {
      transform: translateY(1px);
    }

    /* Form controls */
    label {
      display: block;
      margin-top: 14px;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
      color: var(--header-color);
    }
    
    select, input, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 12px;
      font-size: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      transition: all 0.2s ease;
      font-family: 'Roboto', Arial, sans-serif;
    }
    
    select:hover, input:hover, textarea:hover {
      border-color: #bbbbbb;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }

    /* Integration section */
    .integration-settings {
      background-color: var(--light-bg);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .integration-settings:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    /* Buttons */
    .buttons-container {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      border-top: 1px solid #eee;
      padding-top: 16px;
    }

    button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-family: 'Roboto', Arial, sans-serif;
    }
    
    button .icon {
      font-size: 18px;
    }
    
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--hover-color);
    }
    
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    /* Notifications */
    #error-message, #success-message, #warning-message {
      margin-top: 15px;
      padding: 12px 16px;
      border-radius: 8px;
      display: none;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #error-message {
      background-color: #ffebee;
      border-left: 4px solid var(--danger-color);
      color: #b71c1c;
    }

    #success-message {
      background-color: #e8f5e9;
      border-left: 4px solid var(--success-color);
      color: #1b5e20;
    }
    
    #warning-message {
      background-color: #fff8e1;
      border-left: 4px solid var(--warning-color);
      color: #856404;
    }

    /* Metadata display */
    .meta-info {
      background: var(--light-bg);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .meta-info span {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .meta-info .icon {
      color: var(--primary-color);
    }

    .helper-text {
      font-size: 12px;
      color: #757575;
      margin-top: -8px;
      margin-bottom: 12px;
      font-style: italic;
    }

    .backup-list {
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 12px;
      background: white;
    }
    
    .backup-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }
    
    .backup-item:hover {
      background-color: #f5f5f5;
    }
    
    .backup-item:last-child {
      border-bottom: none;
    }
    
    .backup-date {
      font-weight: 500;
    }
    
    /* JSON code blocks */
    .json-textarea {
      font-family: monospace;
      font-size: 12px;
      height: 150px;
      overflow-y: auto;
      white-space: pre;
      background-color: #f8f9fa;
      resize: vertical;
    }
    
    /* Advanced section */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Property type selector */
    .type-select {
      width: 120px;
      margin-right: 8px;
    }
    
    /* Add property button */
    #addPropertyBtn {
      margin-top: 16px;
      align-self: flex-start;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
  <h3><span class="icon">‚öôÔ∏è</span> Tracker Settings & Initialization</h3>
  
  <div id="error-message"></div>
  <div id="success-message"></div>
  <div id="warning-message"></div>
  
  <div class="meta-info" id="config-metadata">
    <span><span class="icon">üìä</span> Version: <b>Loading...</b></span>
    <span><span class="icon">üïí</span> Last Modified: <b>Loading...</b></span>
  </div>
  
  <div class="tab-container">
    <div class="tab-buttons">
      <div id="tab-btn-properties" class="tab-button active" onclick="showTab('properties')">
        <span class="icon">üîß</span> Properties
      </div>
      <div id="tab-btn-initialize" class="tab-button" onclick="showTab('initialize')">
        <span class="icon">üöÄ</span> Initialize Jobs
      </div>
      <div id="tab-btn-integrations" class="tab-button" onclick="showTab('integrations')">
        <span class="icon">üîó</span> Integrations
      </div>
      <div id="tab-btn-advanced" class="tab-button" onclick="showTab('advanced')">
        <span class="icon">üõ†Ô∏è</span> Advanced
      </div>
    </div>
    
    <!-- Properties Tab -->
    <div id="tab-properties" class="tab-content active">
      <p>Modify existing properties or add new ones. These properties define dropdown values in your tracking sheets.</p>
      <div id="propertiesList"></div>
      <button id="addPropertyBtn" class="btn-primary">
        <span class="icon">+</span> Add Property
      </button>
    </div>
    
    <!-- Initialize Jobs Tab -->
    <div id="tab-initialize" class="tab-content">
      <p>Initialize a new jobs sheet from template, or add jobs to an existing sheet.</p>
      
      <label for="jobSheetName">Sheet Name:</label>
      <input type="text" id="jobSheetName" value="Jobs" placeholder="Enter sheet name">
      <div class="helper-text">Default is "Jobs". Change this to create a new tracking sheet.</div>
      
      <label for="defaultJobsSource">Source for Default Jobs:</label>
      <select id="defaultJobsSource">
        <option value="DefaultJobs">DefaultJobs sheet</option>
        <option value="empty">Empty sheet (headers only)</option>
      </select>
      
      <div id="jobSourceOptions" style="margin-top: 16px; padding: 12px 16px; background-color: var(--light-bg); border-radius: 8px; border: 1px solid var(--border-color);">
        <p>Jobs will be read from the "DefaultJobs" sheet. Make sure it contains at least these columns:</p>
        <ul>
          <li><strong>Job Name</strong> (required)</li>
          <li>Job Link (optional)</li>
          <li>Jira Ticket (optional)</li>
        </ul>
      </div>
      
      <div class="buttons-container">
        <button id="initJobsBtn" class="btn-success">
          <span class="icon">‚ú®</span> Initialize Jobs Sheet
        </button>
      </div>
    </div>
    
    <!-- Integrations Tab -->
    <div id="tab-integrations" class="tab-content">
      <p>Configure integrations with external systems to enable hyperlinks in your job sheets.</p>
      
      <div class="integration-settings">
        <h4><span class="icon">üèóÔ∏è</span> Jenkins Integration</h4>
        <label for="jenkinsUrl">Jenkins Base URL:</label>
        <input type="text" id="jenkinsUrl" placeholder="https://jenkins.example.com/">
        <div class="helper-text">Used for "Job Link" hyperlinks. Include trailing slash.</div>
      </div>
      
      <div class="integration-settings">
        <h4><span class="icon">üéØ</span> Jira Integration</h4>
        <label for="jiraUrl">Jira Base URL:</label>
        <input type="text" id="jiraUrl" placeholder="https://jira.example.com/browse/">
        <div class="helper-text">Used for "Jira Ticket" hyperlinks. Include trailing slash and "browse/" if needed.</div>
      </div>
    </div>
    
    <!-- Advanced Tab (Backup/Restore) -->
    <div id="tab-advanced" class="tab-content">
      <h4><span class="icon">üíæ</span> Backup & Restore</h4>
      <p>Manage configuration backups or import/export settings.</p>
      
      <h4><span class="icon">üìÅ</span> Available Backups</h4>
      <div class="backup-list" id="backups-list">
        <div style="padding: 16px; text-align: center;">
          <div style="margin-bottom: 8px; display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(25, 118, 210, 0.2); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <div>Loading backups...</div>
        </div>
      </div>
      <button onclick="loadBackupsList()" class="btn-secondary">
        <span class="icon">üîÑ</span> Refresh List
      </button>
      
      <h4><span class="icon">üì§</span> Export Configuration</h4>
      <textarea id="export-json" class="json-textarea" readonly></textarea>
      <div class="action-buttons">
        <button onclick="exportConfigToJson()" class="btn-primary">
          <span class="icon">üì•</span> Export
        </button>
        <button onclick="copyToClipboard()" class="btn-secondary">
          <span class="icon">üìã</span> Copy
        </button>
      </div>
      
      <h4><span class="icon">üì•</span> Import Configuration</h4>
      <textarea id="import-json" class="json-textarea" placeholder="Paste configuration JSON here..."></textarea>
      <div class="action-buttons">
        <button onclick="importConfigFromJson()" class="btn-primary">
          <span class="icon">üì•</span> Import
        </button>
        <button onclick="clearImportText()" class="btn-secondary">
          <span class="icon">üóëÔ∏è</span> Clear
        </button>
      </div>
    </div>
  </div>

  <div class="buttons-container">
    <button id="saveBtn" class="btn-success">
      <span class="icon">üíæ</span> Save Settings
    </button>
    <button id="cancelBtn" class="btn-secondary">
      <span class="icon">‚úñ</span> Close
    </button>
  </div>

  <script>
    // Global property storage
    let properties = [];
    let configMetadata = {};
    let availableBackups = [];
    
    document.addEventListener("DOMContentLoaded", function() {
      // Show the default tab
      showTab('properties');
      
      // Load settings
      loadSettings();
      
      // Set up event listeners
      document.getElementById("addPropertyBtn").addEventListener("click", () => {
        properties.push({ 
          name: "", 
          type: "text", 
          values: [], 
          colors: [] 
        });
        renderProperties(properties);
      });

      document.getElementById("saveBtn").addEventListener("click", saveSettings);
      document.getElementById("cancelBtn").addEventListener("click", () => {
        google.script.host.close();
      });
      document.getElementById("initJobsBtn").addEventListener("click", initializeJobsSheet);
      document.getElementById("defaultJobsSource").addEventListener("change", updateJobSourceOptions);
    });
    
    function loadSettings() {
      // Show loading message
      showMessage('success', 'Loading settings...');
      
      // Load the configuration
      google.script.run
          .withSuccessHandler(onLoadConfigSuccess)
          .withFailureHandler(onLoadConfigFailure)
          .loadConfig();
      
      // Load metadata
      google.script.run
          .withSuccessHandler(onLoadMetadataSuccess)
          .withFailureHandler(error => console.error("Metadata error:", error))
          .getConfigMetadata();
      
      // Load available backups
      loadBackupsList();
      
      // Load integration settings
      google.script.run
          .withSuccessHandler(loadIntegrationSettings)
          .withFailureHandler(error => console.error("Integration settings error:", error))
          .getIntegrationSettings();
    }
    
    function loadIntegrationSettings(settings) {
      if (settings) {
        document.getElementById("jenkinsUrl").value = settings.jenkinsUrl || "";
        document.getElementById("jiraUrl").value = settings.jiraUrl || "";
      }
    }
    
    function onLoadConfigSuccess(data) {
      renderProperties(data);
      hideMessages();
    }

    function onLoadConfigFailure(error) {
      console.error("Error loading settings:", error);
      showMessage('error', "Failed to load settings. Please try again later.");
    }
    
    function onLoadMetadataSuccess(metadata) {
      configMetadata = metadata;
      updateMetadataDisplay();
    }
    
    function updateMetadataDisplay() {
      const metaInfoDiv = document.getElementById("config-metadata");
      if (metaInfoDiv && configMetadata) {
        metaInfoDiv.innerHTML = `
          <span><span class="icon">üìä</span> Version: <b>${configMetadata.version || 'Unknown'}</b></span>
          <span><span class="icon">üïí</span> Last Modified: <b>${formatDate(configMetadata.lastModified)}</b></span>
          <span><span class="icon">üìã</span> Statuses: <b>${configMetadata.statusCount || 0}</b></span>
          <span><span class="icon">üîñ</span> Types: <b>${configMetadata.typeCount || 0}</b></span>
          <span><span class="icon">üîë</span> Priorities: <b>${configMetadata.priorityCount || 0}</b></span>
        `;
      }
    }
    
    function formatDate(dateString) {
      if (!dateString || dateString === 'Unknown') return 'Unknown';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      } catch (e) {
        return dateString;
      }
    }
    
    function loadBackupsList() {
      google.script.run
          .withSuccessHandler(onLoadBackupsSuccess)
          .withFailureHandler(error => console.error("Backups error:", error))
          .getBackupsList();
    }
    
    function onLoadBackupsSuccess(backups) {
      availableBackups = backups;
      renderBackupsList();
    }
    
    function renderBackupsList() {
      const backupsList = document.getElementById("backups-list");
      if (!backupsList || !availableBackups) return;
      
      if (availableBackups.length === 0) {
        backupsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #757575;">No backups available</div>';
        return;
      }
      
      backupsList.innerHTML = availableBackups.map(backup => `
        <div class="backup-item">
          <div class="backup-date">${backup.readableDate}</div>
          <button class="btn-secondary" onclick="confirmRestore('${backup.key}')">
            <span class="icon">‚Ü©Ô∏è</span> Restore
          </button>
        </div>
      `).join('');
    }
    
    function updateJobSourceOptions() {
      const source = document.getElementById("defaultJobsSource").value;
      const optionsDiv = document.getElementById("jobSourceOptions");
      
      if (source === "DefaultJobs") {
        optionsDiv.innerHTML = `
          <p>Jobs will be read from the "DefaultJobs" sheet. Make sure it contains at least these columns:</p>
          <ul>
            <li><strong>Job Name</strong> (required)</li>
            <li>Job Link (optional)</li>
            <li>Jira Ticket (optional)</li>
          </ul>
        `;
      } else {
        optionsDiv.innerHTML = `
          <p>An empty sheet will be created with the proper headers and validation.</p>
        `;
      }
    }
    
    function initializeJobsSheet() {
      const sheetName = document.getElementById("jobSheetName").value.trim();
      if (!sheetName) {
        showMessage('error', 'Please enter a sheet name');
        return;
      }
      
      const source = document.getElementById("defaultJobsSource").value;
      
      showMessage('warning', 'Initializing jobs sheet...');
      
      // Save integration settings first
      saveIntegrationSettings()
        .then(() => {
          google.script.run
            .withSuccessHandler(onInitializeSuccess)
            .withFailureHandler(onInitializeFailure)
            .initializeJobsSheet(sheetName, source);
        })
        .catch(error => {
          showMessage('error', 'Failed to save integration settings: ' + error);
        });
    }
    
    function saveIntegrationSettings() {
      return new Promise((resolve, reject) => {
        const settings = {
          jenkinsUrl: document.getElementById("jenkinsUrl").value.trim(),
          jiraUrl: document.getElementById("jiraUrl").value.trim()
        };
        
        google.script.run
          .withSuccessHandler(result => resolve(result))
          .withFailureHandler(error => reject(error))
          .saveIntegrationSettings(settings);
      });
    }
    
    function onInitializeSuccess(result) {
      showMessage('success', result.message || 'Jobs sheet initialized successfully');
    }
    
    function onInitializeFailure(error) {
      showMessage('error', 'Failed to initialize jobs sheet: ' + error);
    }
    
    function confirmRestore(backupKey) {
      if (confirm("Are you sure you want to restore this configuration backup? Current settings will be replaced.")) {
        restoreBackup(backupKey);
      }
    }
    
    function restoreBackup(backupKey) {
      showMessage('warning', 'Restoring backup...');
      google.script.run
          .withSuccessHandler(onRestoreSuccess)
          .withFailureHandler(onRestoreFailure)
          .restoreBackup(backupKey);
    }
    
    function onRestoreSuccess(result) {
      showMessage('success', 'Backup restored successfully!');
      // Reload settings to reflect restored config
      loadSettings();
    }
    
    function onRestoreFailure(error) {
      showMessage('error', 'Failed to restore backup: ' + error);
    }
    
    function exportConfigToJson() {
      google.script.run
          .withSuccessHandler(onExportSuccess)
          .withFailureHandler(onExportFailure)
          .exportConfig();
    }
    
    function onExportSuccess(result) {
      const exportTextarea = document.getElementById('export-json');
      if (exportTextarea && result.data) {
        exportTextarea.value = result.data;
        showMessage('success', 'Configuration exported successfully!');
      } else {
        showMessage('error', 'Failed to export configuration');
      }
    }
    
    function onExportFailure(error) {
      showMessage('error', 'Failed to export configuration: ' + error);
    }
    
    function importConfigFromJson() {
      const importTextarea = document.getElementById('import-json');
      if (!importTextarea || !importTextarea.value.trim()) {
        showMessage('error', 'Please enter configuration JSON to import');
        return;
      }
      
      if (confirm("Are you sure you want to import this configuration? Current settings will be replaced.")) {
        showMessage('warning', 'Importing configuration...');
        google.script.run
            .withSuccessHandler(onImportSuccess)
            .withFailureHandler(onImportFailure)
            .importConfig(importTextarea.value);
      }
    }
    
    function onImportSuccess(result) {
      showMessage('success', 'Configuration imported successfully!');
      // Reload settings to reflect imported config
      loadSettings();
    }
    
    function onImportFailure(error) {
      showMessage('error', 'Failed to import configuration: ' + error);
    }
    
    function copyToClipboard() {
      const exportTextarea = document.getElementById('export-json');
      if (exportTextarea) {
        exportTextarea.select();
        document.execCommand('copy');
        showMessage('success', 'Copied to clipboard!');
      }
    }
    
    function clearImportText() {
      const importTextarea = document.getElementById('import-json');
      if (importTextarea) {
        importTextarea.value = '';
      }
    }

    function showTab(tabName) {
      // Hide all tabs
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      
      // Deactivate all tab buttons
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      // Show selected tab
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.getElementById(`tab-btn-${tabName}`).classList.add('active');
    }
    
    function renderProperties(data) {
      // Ensure data is an array with at least some default values
      properties = Array.isArray(data) && data.length > 0 ? data : [
        { 
          name: "Status", 
          type: "dropdown", 
          values: ["Pending", "In-Progress", "Done"], 
          colors: ["#e3f2fd", "#fff8e1", "#e8f5e9"] 
        },
        { 
          name: "Job Type", 
          type: "dropdown", 
          values: ["Build", "Test", "Deploy"], 
          colors: ["#ede7f6", "#e0f7fa", "#f3e5f5"] 
        },
        { 
          name: "Priority", 
          type: "dropdown", 
          values: ["High", "Medium", "Low"], 
          colors: ["#ffebee", "#fff8e1", "#e8f5e9"] 
        }
      ];

      const container = document.getElementById("propertiesList");
      if (!container) return;
      
      container.innerHTML = "";
      
      properties.forEach((prop, index) => {
        // Make sure values and colors are arrays
        if (!Array.isArray(prop.values)) prop.values = [];
        if (!Array.isArray(prop.colors)) prop.colors = [];
        
        const div = document.createElement("div");
        div.classList.add("property-item");

        const valuesHTML = prop.values.map((val, i) => `
          <div class="value-box">
            <input type="text" value="${val || ''}" onchange="updateValue(${index}, ${i}, this.value)">
            <input type="color" class="color-picker" value="${prop.colors[i] || '#cccccc'}" onchange="updateColor(${index}, ${i}, this.value)">
            <button class="remove-value-btn" onclick="removeValue(${index}, ${i})">‚úï</button>
          </div>
        `).join("");

        div.innerHTML = `
          <div class="property-header">
            <input type="text" value="${prop.name || ''}" placeholder="Property Name" data-index="${index}" onchange="updatePropertyName(${index}, this.value)">
            <select class="type-select" data-index="${index}" onchange="changeType(this, ${index})">
              <option value="text" ${prop.type === "text" ? "selected" : ""}>Text</option>
              <option value="dropdown" ${prop.type === "dropdown" ? "selected" : ""}>Dropdown</option>
            </select>
            <button class="remove-btn" onclick="removeProperty(${index})">
              <span class="icon">üóëÔ∏è</span> Delete
            </button>
          </div>
          <div class="value-container" id="values-${index}" style="display: ${prop.type === 'dropdown' ? 'flex' : 'none'};">
            ${valuesHTML}
            <button class="btn-primary" style="padding: 8px 12px; margin-top: 0;" onclick="addDropdownValue(${index})">
              <span class="icon" style="font-size: 16px;">+</span> Add Value
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    
    function updatePropertyName(index, newName) {
      properties[index].name = newName;
    }

    function changeType(selectElement, index) {
      const value = selectElement.value;
      properties[index].type = value;

      const valuesContainer = document.getElementById(`values-${index}`);
      if (valuesContainer) {
        valuesContainer.style.display = value === 'dropdown' ? 'flex' : 'none';
      }

      if (value === 'text') {
        properties[index].values = [];
        properties[index].colors = [];
        renderProperties(properties); // Re-render to update the display
      }
    }

    function updateValue(propertyIndex, valueIndex, newValue) {
      if (!properties[propertyIndex].values) {
        properties[propertyIndex].values = [];
      }
      properties[propertyIndex].values[valueIndex] = newValue;
    }

    function updateColor(propertyIndex, valueIndex, newColor) {
      if (!properties[propertyIndex].colors) {
        properties[propertyIndex].colors = [];
      }
      properties[propertyIndex].colors[valueIndex] = newColor;
    }

    function removeValue(propertyIndex, valueIndex) {
      if (Array.isArray(properties[propertyIndex].values)) {
        properties[propertyIndex].values.splice(valueIndex, 1);
      }
      if (Array.isArray(properties[propertyIndex].colors)) {
        properties[propertyIndex].colors.splice(valueIndex, 1);
      }
      renderProperties(properties);
    }

    function addDropdownValue(propertyIndex) {
      if (!properties[propertyIndex].values) {
        properties[propertyIndex].values = [];
      }
      if (!properties[propertyIndex].colors) {
        properties[propertyIndex].colors = [];
      }
      properties[propertyIndex].values.push("");
      properties[propertyIndex].colors.push("#e3f2fd");
      renderProperties(properties);
    }

    function removeProperty(index) {
      properties.splice(index, 1);
      renderProperties(properties);
    }
    
    function showMessage(type, message) {
      hideMessages();
      const messageDiv = document.getElementById(`${type}-message`);
      if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        
        if (type !== 'error' && type !== 'warning') {
          setTimeout(() => {
            messageDiv.style.display = 'none';
          }, 5000);
        }
      }
    }
    
    function hideMessages() {
      ['success', 'error', 'warning'].forEach(type => {
        const msgDiv = document.getElementById(`${type}-message`);
        if (msgDiv) msgDiv.style.display = 'none';
      });
    }
    
    function saveSettings() {
      hideMessages();
      showMessage('warning', 'Saving settings...');
      
      // First save integration settings
      saveIntegrationSettings()
        .then(() => {
          // Then save main configuration settings
          // Make sure properties is properly formed before saving
          const cleanProperties = properties.map(prop => ({
            name: prop.name || "",
            type: prop.type || "text",
            values: Array.isArray(prop.values) ? prop.values : [],
            colors: Array.isArray(prop.colors) ? prop.colors : []
          }));
          
          google.script.run
              .withSuccessHandler(onSaveConfigSuccess)
              .withFailureHandler(onSaveConfigFailure)
              .saveConfig(cleanProperties);
        })
        .catch(error => {
          showMessage('error', 'Failed to save integration settings: ' + error);
        });
    }
    
    function onSaveConfigSuccess(result) {
      showMessage('success', result.message || 'Settings saved successfully!');
      
      // Refresh metadata and backups
      google.script.run
          .withSuccessHandler(onLoadMetadataSuccess)
          .getConfigMetadata();
      
      loadBackupsList();
    }

    function onSaveConfigFailure(error) {
      showMessage('error', 'Failed to save settings: ' + error);
    }
  </script>
</body>
</html>